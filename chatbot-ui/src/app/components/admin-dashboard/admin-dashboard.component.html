<div class="dashboard" [ngClass]="theme">
  <div class="header">
    <h2>Admin Dashboard</h2>

    <button mat-button class="profile-btn" [matMenuTriggerFor]="adminMenu" aria-label="Menu administrateur">
      <span class="avatar">{{ initials }}</span>
      <mat-icon>expand_more</mat-icon>
    </button>

    <mat-menu #adminMenu="matMenu">
      <button mat-menu-item (click)="toggleTheme()">
        <mat-icon>{{ theme === 'dark' ? 'light_mode' : 'dark_mode' }}</mat-icon>
        <span>{{ theme === 'dark' ? 'Passer en clair' : 'Passer en sombre' }}</span>
      </button>

      <mat-divider></mat-divider>

      <button mat-menu-item [routerLink]="['/admin/users']">
        <mat-icon>group</mat-icon>
        <span>Utilisateurs</span>
      </button>

      <mat-divider></mat-divider>

      <button mat-menu-item (click)="logout()">
        <mat-icon color="warn">logout</mat-icon>
        <span>Déconnexion</span>
      </button>
    </mat-menu>
  </div>

  <div class="kpis">
    <mat-card class="kpi">
      <div class="kpi-head"><span class="dot"></span><span class="kpi-title">Utilisateurs</span></div>
      <div class="kpi-value">{{ stats.users }}</div>
    </mat-card>

    <mat-card class="kpi">
      <div class="kpi-head"><span class="dot"></span><span class="kpi-title">Conversations actives</span></div>
      <div class="kpi-value">{{ stats.activeConversations }}</div>
    </mat-card>

    <mat-card class="kpi">
      <div class="kpi-head"><span class="dot"></span><span class="kpi-title">Durée moy. conv (min)</span></div>
      <div class="kpi-value">{{ stats.avgConvMin | number:'1.0-1' }}</div>
    </mat-card>
  </div>

  <mat-card class="range-card">
    <div class="range-row">
      <label>Du : <input type="date" [(ngModel)]="fromISO" /></label>
      <label>Au : <input type="date" [(ngModel)]="toISO" /></label>
      <button mat-raised-button color="primary" class="btn-apply" (click)="applyRange()">Appliquer</button>
    </div>
  </mat-card>

  <mat-card class="section">
    <div class="section-title">Inscriptions par jour</div>
    <apx-chart
      [series]="signupsSeries"
      [chart]="signupsChart"
      [xaxis]="signupsXAxis"
      [stroke]="signupsStroke"
      [fill]="signupsFill"
      [dataLabels]="signupsLabels"
      [legend]="signupsLegend"
      [noData]="signupsNoData"
    ></apx-chart>
  </mat-card>

  <mat-card class="section">
    <div class="section-title row">
      <span>Latence du bot (p50/p90/moyenne, s)</span>
      <div class="tools">
        <span class="slo">SLO P90 (s) :
          <input type="number" step="0.1" [(ngModel)]="sloP90" (ngModelChange)="refreshSloAnnotation()">
        </span>
        <button mat-stroked-button color="primary" (click)="runSummary()">Synthèse SRE</button>
        <button mat-stroked-button color="accent"  (click)="runForecast()">Nowcast 1h</button>
      </div>
    </div>

    <apx-chart
      [series]="latSeries"
      [chart]="latChart"
      [xaxis]="latXAxis"
      [stroke]="latStroke"
      [dataLabels]="latLabels"
      [legend]="latLegend"
      [tooltip]="latTooltip"
      [annotations]="latAnnotations"
      [noData]="latNoData"
    ></apx-chart>

    <div class="ai-brief" *ngIf="iaSummary?.summary_text">
      <div class="brief-head">
        <div>
          <div class="title">Synthèse SRE</div>
          <div class="subtitle">Fenêtre: {{ fromISO }} → {{ toISO }} • Indicateur clé: Latence P90</div>
        </div>
        <div class="meta">
          <span class="pill">SLO cible: P90 ≤ {{ sloP90 }}s</span>
          <span class="pill">Statut: {{ iaStatus }}</span>
        </div>
      </div>

      <div class="section">
        <h4>Analyse</h4>
        <div class="md" [innerHTML]="summaryHTML"></div>
      </div>
    </div>

    <div class="ia-forecast" *ngIf="iaForecast?.points?.length">
      <h4>Nowcast (prochaine heure) — SLO p90={{ iaForecast?.slo_p90 }}</h4>
      <div class="risk-badge" [class.alert]="iaForecast?.alert">
        Risque max de dépasser le SLO :
        <strong>{{ (iaForecast?.overall_max_prob || 0) | percent:'1.0-0' }}</strong>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Heure</th><th>P90 prédit</th><th>IC bas–haut</th><th>Risque</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of iaForecast!.points">
              <td>{{ p.ts | date:'HH:mm' }}</td>
              <td>{{ p.p90_pred | number:'1.2-2' }} s</td>
              <td>{{ p.low | number:'1.2-2' }} – {{ p.high | number:'1.2-2' }} s</td>
              <td><span class="chip" [ngClass]="p.risk_level">{{ p.risk_level }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </mat-card>

  <mat-card class="section">
    <div class="section-title">Messages par jour</div>
    <apx-chart
      [series]="msgsSeriesChart"
      [chart]="msgsChart"
      [xaxis]="msgsXAxis"
      [yaxis]="msgsYAxis"
      [plotOptions]="msgsPlotOptions"
      [dataLabels]="msgsDataLabels"
      [fill]="msgsFill"
      [stroke]="msgsStroke"
      [grid]="msgsGrid"
      [theme]="msgsTheme"
      [tooltip]="msgsTooltip"
      [noData]="msgsNoData"
    ></apx-chart>
  </mat-card>

  <mat-card class="section">
    <div class="section-title">Heatmap (jours x heures)</div>
    <div class="heatmap">
      <div class="heat-row" *ngFor="let row of heat; let i = index">
        <div class="heat-day">{{ weekDayName(i) }}</div>
        <div class="heat-cell" *ngFor="let val of row; let h = index"
             [style.opacity]="maxHeat ? (val / maxHeat) : 0"
             [attr.title]="weekDayName(i) + ' ' + h + 'h: ' + val"></div>
      </div>
    </div>
  </mat-card>
</div>
